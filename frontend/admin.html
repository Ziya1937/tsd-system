<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∞–º–∏</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f0f9;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #a100ff;
      margin-bottom: 20px;
    }

    .nav {
      margin-bottom: 20px;
    }

    .nav button {
      background: #a100ff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .nav button:hover {
      background: #8b00d1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #faf5ff;
      color: #5e007d;
    }

    .busy {
      background-color: #ffcccc;
    }

    .repair {
      background-color: #ffd699;
    }

    .broken {
      background-color: #ffff99;
    }

    .actions button {
      margin: 2px;
      padding: 5px 10px;
      background: #e0e0e0;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .actions button:hover {
      background: #ccc;
    }
  </style>
</head>
<body>
  <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∞–º–∏</h1>

  <div class="nav">
    <button onclick="location.href='/admin/serials'">–°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞</button>
    <button onclick="location.href='/admin/history-page'">–ò—Å—Ç–æ—Ä–∏—è —è—á–µ–µ–∫</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>ID</th>
        <th>–í—Ä–µ–º—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="cells-body"></tbody>
  </table>

  <script>
    async function loadStatus() {
      const res = await fetch('/status');
      const status = await res.json();
      const tbody = document.getElementById("cells-body");
      tbody.innerHTML = "";

      for (let i = 1; i <= 100; i++) {
        const s = status[i];
        const row = document.createElement("tr");

        if (s.inRepair) {
          row.className = s.repairType === 'broken' ? "broken" : "repair";
        } else if (s.busy) {
          row.className = "busy";
        }

        row.innerHTML = `
          <td>${i}</td>
          <td>${
            s.inRepair 
              ? (s.repairType === 'broken' ? "‚ö†Ô∏è –°–ª–æ–º–∞–Ω" : "üîß –ù–∞ —Ä–µ–º–æ–Ω—Ç–µ")
              : s.busy 
                ? "üî¥ –ó–∞–Ω—è—Ç–∞" 
                : "üü¢ –°–≤–æ–±–æ–¥–Ω–∞"
          }</td>
          <td>${s.badge || ""}</td>
          <td>${s.time ? new Date(s.time).toLocaleString() : ""}</td>
          <td class="actions">
            <button onclick="release(${i})">–í–µ—Ä–Ω—É—Ç—å</button>
            <button onclick="occupy(${i})">–ó–∞–Ω—è—Ç—å</button>
            <button onclick="repair(${i})">–†–µ–º–æ–Ω—Ç</button>
            <button onclick="markBroken(${i})">–°–ª–æ–º–∞–Ω</button>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    async function release(cell) {
      await fetch('/admin/repair-release', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell })
      });
      loadStatus();
    }

    async function occupy(cell) {
      const badge = prompt("–í–≤–µ–¥–∏—Ç–µ ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:");
      if (!badge) return;
      await fetch('/admin/occupy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell, badge })
      });
      loadStatus();
    }

    async function repair(cell) {
      const badge = prompt("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π ID (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä):");
      if (!badge) return;
      await fetch('/admin/repair', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell, badge })
      });
      loadStatus();
    }

    async function markBroken(cell) {
      const badge = prompt("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π ID (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä):");
      if (!badge) return;
      await fetch('/admin/mark-broken', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell, badge })
      });
      loadStatus();
    }

    loadStatus();
    setInterval(loadStatus, 5000);
  </script>
</body>
</html>