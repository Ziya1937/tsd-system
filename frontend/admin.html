<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    h1 { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .busy { background: #ffdddd; }
    .repair { background: #fff2cc; }
    button { padding: 6px 12px; margin: 2px; }
    pre { background: #eee; padding: 10px; max-height: 400px; overflow: auto; }
  </style>
</head>
<body>
  <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

  <h3>–°—Ç–∞—Ç—É—Å —è—á–µ–µ–∫</h3>
  <table id="cells-table">
    <thead>
      <tr>
        <th>‚Ññ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ë–µ–π–¥–∂</th><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>–ò—Å—Ç–æ—Ä–∏—è —è—á–µ–µ–∫</h3>
  <pre id="history">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>

  <script>
    async function loadStatus() {
      const res = await fetch('/status');
      const status = await res.json();

      const tbody = document.querySelector("#cells-table tbody");
      tbody.innerHTML = "";

      for (let i = 1; i <= 100; i++) {
        const s = status[i];
        const row = document.createElement("tr");
      row.className = (s && s.inRepair) ? "repair" : ((s && s.busy) ? "busy" : "");

        row.innerHTML = `
          <td>${i}</td>
          <td>${s.inRepair ? "üîß –í —Ä–µ–º–æ–Ω—Ç–µ" : s.busy ? "üî¥ –ó–∞–Ω—è—Ç–∞" : "üü¢ –°–≤–æ–±–æ–¥–Ω–∞"}</td>
          <td>${s.badge || ""}</td>
          <td>${s.time ? new Date(s.time).toLocaleString() : ""}</td>
          <td>
            <button onclick="release(${i})">–û—Å–≤–æ–±–æ–¥–∏—Ç—å</button>
            <button onclick="occupy(${i})">–ó–∞–Ω—è—Ç—å</button>
            <button onclick="repair(${i})">–†–µ–º–æ–Ω—Ç</button>
            <button onclick="repairRelease(${i})">–í–µ—Ä–Ω—É—Ç—å</button>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    async function loadHistory() {
      const res = await fetch('/admin/history');
      const history = await res.json();
      const lines = [];

      Object.entries(history).forEach(([cell, events]) => {
        if (events.length === 0) return;
        lines.push(`\nüóÇ –Ø—á–µ–π–∫–∞ ${cell}`);
        events.forEach(e => {
          lines.push`(- ${e.timestamp} | ${e.action} | ${e.badge} ${e.admin ? "(admin)" : ""})`;
        });
      });

      document.getElementById("history").innerText = lines.join("\n");
    }

    async function release(cell) {
      await fetch('/admin/release-cell', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell })
      });
      loadStatus(); loadHistory();
    }

    async function occupy(cell) {
      const badge = prompt("–í–≤–µ–¥–∏—Ç–µ –±–µ–π–¥–∂ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:");
      if (!badge) return;
      await fetch('/admin/occupy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell, badge })
      });
      loadStatus(); loadHistory();
    }

    async function repair(cell) {
      const adminBadge = prompt("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±–µ–π–¥–∂ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
      if (!adminBadge) return;
      await fetch('/admin/repair', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell, badge: adminBadge })
      });
      loadStatus(); loadHistory();
    }

    async function repairRelease(cell) {
      await fetch('/admin/repair-release', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cell })
      });
      loadStatus(); loadHistory();
    }

    loadStatus();
    loadHistory();
    setInterval(() => {
      loadStatus();
      loadHistory();
    }, 5000);
  </script>
</body>
</html>